name: CI/CD Pipeline

on:
  push:
    branches:
      - development
      - main
  pull_request:
    branches:
      - development
      - main

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore
        working-directory: ./Overflow

      - name: Build
        run: dotnet build --no-restore --configuration Release
        working-directory: ./Overflow

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal
        working-directory: ./Overflow

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push QuestionService image
        working-directory: ./Overflow/QuestionService
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-questions:${{ env.IMAGE_TAG }} .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-questions:${{ env.IMAGE_TAG }}

      - name: Build and push SearchService image
        working-directory: ./Overflow/SearchService
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-search:${{ env.IMAGE_TAG }} .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-search:${{ env.IMAGE_TAG }}

  deploy-staging:
    needs: build-and-test
    if: github.ref == 'refs/heads/development' && github.event_name == 'push'
    runs-on: self-hosted  # Runs on helios
    environment: staging  # Uses staging environment secrets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl context
        run: |
          mkdir -p $HOME/.kube
          kubectl config use-context default

      - name: Update kustomization with image tags
        working-directory: ./Overflow/k8s/overlays/staging
        run: |
          # Update GitHub org placeholder
          sed -i "s/placeholder/${{ github.repository_owner }}/g" kustomization.yaml
          
          # Update image tags
          kustomize edit set image \
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-questions=${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-questions:${{ env.IMAGE_TAG }}
          
          kustomize edit set image \
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-search=${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-search:${{ env.IMAGE_TAG }}

      - name: Update secrets from environment-specific GitHub Secrets
        working-directory: ./Overflow/k8s/overlays/staging
        run: |
          # Replace placeholder secrets with actual values from environment-specific GitHub Secrets
          # No need for _STAGING suffix since we're using environment: staging
          
          # Update postgres connection string
          sed -i "s|postgres-connection=.*|postgres-connection=${{ secrets.POSTGRES_QUESTIONS_DB_CONNECTION_STRING }}|g" kustomization.yaml
          
          # Update rabbitmq connection string
          sed -i "s|rabbitmq-connection=.*|rabbitmq-connection=${{ secrets.RABBIT_MQ_AMQP_CONNECTION_STRING }}|g" kustomization.yaml
          
          # Update typesense API key
          sed -i "s|typesense-api-key=.*|typesense-api-key=${{ secrets.TYPESENSE_API_KEY }}|g" kustomization.yaml
          
          # Update keycloak client credentials
          sed -i "s|keycloak-client-id=.*|keycloak-client-id=${{ secrets.KEYCLOAK_CLIENT_ID }}|g" kustomization.yaml
          sed -i "s|keycloak-client-secret=.*|keycloak-client-secret=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|g" kustomization.yaml

      - name: Preview generated manifests
        working-directory: ./Overflow/k8s/overlays/staging
        run: |
          echo "=== Generated Kubernetes Manifests ==="
          kubectl kustomize . | head -n 100

      - name: Deploy to Staging with Kustomize
        working-directory: ./Overflow/k8s/overlays/staging
        run: |
          kubectl apply -k .

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/question-svc -n apps-staging --timeout=5m || echo "Question service rollout timeout"
          kubectl rollout status deployment/search-svc -n apps-staging --timeout=5m || echo "Search service rollout timeout"

      - name: Validate deployment
        run: |
          echo "=== Pods in apps-staging ==="
          kubectl get pods -n apps-staging
          
          echo "=== Services in apps-staging ==="
          kubectl get svc -n apps-staging
          
          echo "=== ConfigMaps in apps-staging ==="
          kubectl get configmaps -n apps-staging
          
          echo "=== Secrets in apps-staging ==="
          kubectl get secrets -n apps-staging
          
          echo "=== Recent logs from question-svc ==="
          kubectl logs -n apps-staging -l app=question-svc --tail=30 --prefix=true || echo "No logs yet"
          
          echo "=== Recent logs from search-svc ==="
          kubectl logs -n apps-staging -l app=search-svc --tail=30 --prefix=true || echo "No logs yet"

  deploy-production:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: self-hosted  # Runs on helios
    environment: production  # Uses production environment secrets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl context
        run: |
          mkdir -p $HOME/.kube
          kubectl config use-context default

      - name: Update kustomization with image tags
        working-directory: ./Overflow/k8s/overlays/production
        run: |
          # Update GitHub org placeholder
          sed -i "s/placeholder/${{ github.repository_owner }}/g" kustomization.yaml
          
          # Update image tags
          kustomize edit set image \
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-questions=${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-questions:${{ env.IMAGE_TAG }}
          
          kustomize edit set image \
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-search=${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/overflow-search:${{ env.IMAGE_TAG }}

      - name: Update secrets from environment-specific GitHub Secrets
        working-directory: ./Overflow/k8s/overlays/production
        run: |
          # Replace placeholder secrets with actual values from environment-specific GitHub Secrets
          # No need for _PRODUCTION suffix since we're using environment: production
          
          # Update postgres connection string
          sed -i "s|postgres-connection=.*|postgres-connection=${{ secrets.POSTGRES_QUESTIONS_DB_CONNECTION_STRING }}|g" kustomization.yaml
          
          # Update rabbitmq connection string
          sed -i "s|rabbitmq-connection=.*|rabbitmq-connection=${{ secrets.RABBIT_MQ_AMQP_CONNECTION_STRING }}|g" kustomization.yaml
          
          # Update typesense API key
          sed -i "s|typesense-api-key=.*|typesense-api-key=${{ secrets.TYPESENSE_API_KEY }}|g" kustomization.yaml
          
          # Update keycloak client credentials
          sed -i "s|keycloak-client-id=.*|keycloak-client-id=${{ secrets.KEYCLOAK_CLIENT_ID }}|g" kustomization.yaml
          sed -i "s|keycloak-client-secret=.*|keycloak-client-secret=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|g" kustomization.yaml

      - name: Preview generated manifests
        working-directory: ./Overflow/k8s/overlays/production
        run: |
          echo "=== Generated Kubernetes Manifests ==="
          kubectl kustomize . | head -n 100

      - name: Deploy to Production with Kustomize
        working-directory: ./Overflow/k8s/overlays/production
        run: |
          kubectl apply -k .

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/question-svc -n apps-production --timeout=5m || echo "Question service rollout timeout"
          kubectl rollout status deployment/search-svc -n apps-production --timeout=5m || echo "Search service rollout timeout"

      - name: Validate deployment
        run: |
          echo "=== Pods in apps-production ==="
          kubectl get pods -n apps-production
          
          echo "=== Services in apps-production ==="
          kubectl get svc -n apps-production
          
          echo "=== ConfigMaps in apps-production ==="
          kubectl get configmaps -n apps-production
          
          echo "=== Secrets in apps-production ==="
          kubectl get secrets -n apps-production
          
          echo "=== Recent logs from question-svc ==="
          kubectl logs -n apps-production -l app=question-svc --tail=30 --prefix=true || echo "No logs yet"
          
          echo "=== Recent logs from search-svc ==="
          kubectl logs -n apps-production -l app=search-svc --tail=30 --prefix=true || echo "No logs yet"

      - name: Smoke tests
        run: |
          echo "Waiting for services to be fully ready..."
          sleep 10
          
          echo "=== Testing question-svc health endpoint ==="
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n apps-production -- \
            curl -f -m 5 http://question-svc:8080/health || echo "Health check failed or endpoint not available"
          
          echo "=== Testing search-svc health endpoint ==="
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n apps-production -- \
            curl -f -m 5 http://search-svc:8080/health || echo "Health check failed or endpoint not available"
