# Combined CI/CD Workflow for .NET Aspire Solution
# Build, Staging Deploy, and Production Deploy in one workflow
name: CI-CD

on:
  workflow_dispatch:
  push:
    branches:
      - development
      - main

jobs:
  build:
    name: Build and Test
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.set_tag.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK (Aspire)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore Overflow.slnx

      - name: Build solution
        run: dotnet build Overflow.slnx --no-restore --configuration Release

      - name: Run tests
        run: dotnet test Overflow.slnx --no-build --configuration Release --logger trx

      - name: Set image tag output
        id: set_tag
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "image_tag=prod-${GITHUB_SHA}" >> $GITHUB_OUTPUT
          else
            echo "image_tag=staging-${GITHUB_SHA}" >> $GITHUB_OUTPUT
          fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/development' || github.event_name == 'workflow_dispatch'
    environment: Staging
    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY || 'docker.io' }}
      IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Questions API image
        run: |
          docker build -t ${{ env.REGISTRY }}/viacheslav/questions-api:${{ env.IMAGE_TAG }} -f QuestionService/Dockerfile .
          docker push ${{ env.REGISTRY }}/viacheslav/questions-api:${{ env.IMAGE_TAG }}

      - name: Build and push Search API image
        run: |
          docker build -t ${{ env.REGISTRY }}/viacheslav/search-api:${{ env.IMAGE_TAG }} -f SearchService/Dockerfile .
          docker push ${{ env.REGISTRY }}/viacheslav/search-api:${{ env.IMAGE_TAG }}

      - name: Build and push Aspire Dashboard image
        run: |
          docker build -t ${{ env.REGISTRY }}/viacheslav/aspire-dashboard:${{ env.IMAGE_TAG }} -f Overflow.AppHost/Dockerfile .
          docker push ${{ env.REGISTRY }}/viacheslav/aspire-dashboard:${{ env.IMAGE_TAG }}

      - name: Set up Kubeconfig for helios (k3s)
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_HELIOS }}" | base64 -d > $HOME/.kube/config

      - name: Set kubectl context
        run: |
          kubectl config use-context default

      - name: Deploy to Staging with Helm
        run: |
          helm upgrade --install overflow-staging charts/overflow \
            --namespace apps-staging \
            --create-namespace \
            --set questionsApi.image.tag=${{ env.IMAGE_TAG }} \
            --set searchApi.image.tag=${{ env.IMAGE_TAG }} \
            --set aspireDashboard.image.tag=${{ env.IMAGE_TAG }} \
            -f charts/overflow/values-staging.yaml
        env:
          POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
          RABBITMQ_CONNECTION_STRING: ${{ secrets.RABBITMQ_CONNECTION_STRING }}
          TYPESENSE_URL: ${{ secrets.TYPESENSE_URL }}
          TYPESENSE_API_KEY: ${{ secrets.TYPESENSE_API_KEY }}
          KEYCLOAK_AUTH_URL: ${{ secrets.KEYCLOAK_AUTH_URL }}
          KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_CLIENT_ID }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}

      - name: Validate deployment (pods)
        run: kubectl get pods -n apps-staging

  deploy-production:
    name: Deploy to Production
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: Production
    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY || 'docker.io' }}
      IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Questions API image
        run: |
          docker build -t ${{ env.REGISTRY }}/viacheslav/questions-api:${{ env.IMAGE_TAG }} -f QuestionService/Dockerfile .
          docker push ${{ env.REGISTRY }}/viacheslav/questions-api:${{ env.IMAGE_TAG }}

      - name: Build and push Search API image
        run: |
          docker build -t ${{ env.REGISTRY }}/viacheslav/search-api:${{ env.IMAGE_TAG }} -f SearchService/Dockerfile .
          docker push ${{ env.REGISTRY }}/viacheslav/search-api:${{ env.IMAGE_TAG }}

      - name: Build and push Aspire Dashboard image
        run: |
          docker build -t ${{ env.REGISTRY }}/viacheslav/aspire-dashboard:${{ env.IMAGE_TAG }} -f Overflow.AppHost/Dockerfile .
          docker push ${{ env.REGISTRY }}/viacheslav/aspire-dashboard:${{ env.IMAGE_TAG }}

      - name: Set up Kubeconfig for helios (k3s)
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_HELIOS }}" | base64 -d > $HOME/.kube/config

      - name: Set kubectl context
        run: |
          kubectl config use-context default

      - name: Deploy to Production with Helm
        run: |
          helm upgrade --install overflow-production charts/overflow \
            --namespace apps-production \
            --create-namespace \
            --set questionsApi.image.tag=${{ env.IMAGE_TAG }} \
            --set searchApi.image.tag=${{ env.IMAGE_TAG }} \
            --set aspireDashboard.image.tag=${{ env.IMAGE_TAG }} \
            -f charts/overflow/values-production.yaml
        env:
          POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
          RABBITMQ_CONNECTION_STRING: ${{ secrets.RABBITMQ_CONNECTION_STRING }}
          TYPESENSE_URL: ${{ secrets.TYPESENSE_URL }}
          TYPESENSE_API_KEY: ${{ secrets.TYPESENSE_API_KEY }}
          KEYCLOAK_AUTH_URL: ${{ secrets.KEYCLOAK_AUTH_URL }}
          KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_CLIENT_ID }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}

      - name: Validate deployment (pods)
        run: kubectl get pods -n apps-production

