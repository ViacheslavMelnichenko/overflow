name: CI/CD Pipeline

on:
  push:
    branches:
      - development
      - main
  pull_request:
    branches:
      - development
      - main

# Add permissions for GITHUB_TOKEN to push to GitHub Container Registry
permissions:
  contents: read
  packages: write

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore Overflow.slnx

      - name: Build
        run: dotnet build Overflow.slnx --no-restore --configuration Release

      - name: Test
        run: dotnet test Overflow.slnx --no-build --configuration Release --verbosity normal

      - name: Convert repository owner to lowercase
        id: repo_owner
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push QuestionService image
        run: |
          docker build -f QuestionService/Dockerfile -t ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-questions:${{ env.IMAGE_TAG }} .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-questions:${{ env.IMAGE_TAG }}

      - name: Build and push SearchService image
        run: |
          docker build -f SearchService/Dockerfile -t ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-search:${{ env.IMAGE_TAG }} .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-search:${{ env.IMAGE_TAG }}

  # ============================================================================
  # STAGING DEPLOYMENT (development branch → apps-staging namespace)
  # ============================================================================
  deploy-staging:
    name: 🚀 Deploy to Staging
    needs: build-and-test
    if: github.ref == 'refs/heads/development' && github.event_name == 'push'
    runs-on: self-hosted
    environment: staging
    env:
      KUBECONFIG: /home/github-runner/.kube/config
      NAMESPACE: apps-staging
      OVERLAY: staging
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup environment
        id: setup
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: ✅ Verify Kubernetes access
        run: |
          kubectl config current-context || echo "Using default context"
          kubectl get nodes

      - name: 🏷️ Update image tags
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s/GITHUB_USERNAME/${{ steps.setup.outputs.owner_lc }}/g" kustomization.yaml
          sed -i "s|newTag: latest|newTag: ${{ env.IMAGE_TAG }}|g" kustomization.yaml

      - name: 🔐 Inject secrets
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s|postgres-connection=.*|postgres-connection=${{ secrets.POSTGRES_QUESTIONS_DB_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|rabbitmq-connection=.*|rabbitmq-connection=${{ secrets.RABBIT_MQ_AMQP_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|typesense-api-key=.*|typesense-api-key=${{ secrets.TYPESENSE_API_KEY }}|g" kustomization.yaml
          sed -i "s|keycloak-client-id=.*|keycloak-client-id=${{ secrets.KEYCLOAK_CLIENT_ID }}|g" kustomization.yaml
          sed -i "s|keycloak-client-secret=.*|keycloak-client-secret=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|g" kustomization.yaml

      - name: 👀 Preview manifests
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl kustomize . | head -n 100

      - name: 🚀 Deploy to Kubernetes
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl apply -k .

      - name: ⏳ Wait for rollout
        run: |
          kubectl rollout status deployment/question-svc -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/search-svc -n ${{ env.NAMESPACE }} --timeout=5m

      - name: 📊 Deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Logs from question-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=question-svc --tail=30 --prefix=true || true
          echo "=== Logs from search-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=search-svc --tail=30 --prefix=true || true

  # ============================================================================
  # PRODUCTION DEPLOYMENT (main branch → apps-production namespace)
  # ============================================================================
  deploy-production:
    name: 🏭 Deploy to Production
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: self-hosted
    environment: production
    env:
      KUBECONFIG: /home/github-runner/.kube/config
      NAMESPACE: apps-production
      OVERLAY: production
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup environment
        id: setup
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: ✅ Verify Kubernetes access
        run: |
          kubectl config current-context || echo "Using default context"
          kubectl get nodes

      - name: 🏷️ Update image tags
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s/GITHUB_USERNAME/${{ steps.setup.outputs.owner_lc }}/g" kustomization.yaml
          sed -i "s|newTag: latest|newTag: ${{ env.IMAGE_TAG }}|g" kustomization.yaml

      - name: 🔐 Inject secrets
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s|postgres-connection=.*|postgres-connection=${{ secrets.POSTGRES_QUESTIONS_DB_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|rabbitmq-connection=.*|rabbitmq-connection=${{ secrets.RABBIT_MQ_AMQP_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|typesense-api-key=.*|typesense-api-key=${{ secrets.TYPESENSE_API_KEY }}|g" kustomization.yaml
          sed -i "s|keycloak-client-id=.*|keycloak-client-id=${{ secrets.KEYCLOAK_CLIENT_ID }}|g" kustomization.yaml
          sed -i "s|keycloak-client-secret=.*|keycloak-client-secret=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|g" kustomization.yaml

      - name: 👀 Preview manifests
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl kustomize . | head -n 100

      - name: 🚀 Deploy to Kubernetes
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl apply -k .

      - name: ⏳ Wait for rollout
        run: |
          kubectl rollout status deployment/question-svc -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/search-svc -n ${{ env.NAMESPACE }} --timeout=5m

      - name: 📊 Deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Logs from question-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=question-svc --tail=30 --prefix=true || true
          echo "=== Logs from search-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=search-svc --tail=30 --prefix=true || true

      - name: 🧪 Smoke tests
        run: |
          sleep 10
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -f -m 5 http://question-svc:8080/health || echo "⚠️ Health check failed"
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -f -m 5 http://search-svc:8080/health || echo "⚠️ Health check failed"

