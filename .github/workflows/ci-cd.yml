name: CI/CD Pipeline

on:
  push:
    branches:
      - development
      - main
  pull_request:
    branches:
      - development
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      branch:
        description: 'Branch to deploy (leave empty for current branch)'
        required: false
        type: string

# Add permissions for GITHUB_TOKEN to push to GitHub Container Registry
permissions:
  contents: read
  packages: write

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ============================================================================
  # BUILD & TEST (runs on every push/PR)
  # ============================================================================
  build-and-test:
    name: üèóÔ∏è Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: üì¶ Restore dependencies
        run: dotnet restore Overflow.slnx

      - name: üî® Build solution
        run: dotnet build Overflow.slnx --no-restore --configuration Release

      - name: üß™ Run tests
        run: dotnet test Overflow.slnx --no-build --configuration Release --verbosity normal

      - name: üîß Setup environment
        id: repo_owner
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: üîë Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Build & push QuestionService
        run: |
          docker build -f QuestionService/Dockerfile -t ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-question:${{ env.IMAGE_TAG }} .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-question:${{ env.IMAGE_TAG }}

      - name: üê≥ Build & push SearchService
        run: |
          docker build -f SearchService/Dockerfile -t ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-search:${{ env.IMAGE_TAG }} .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-search:${{ env.IMAGE_TAG }}

      - name: üê≥ Build & push WebApp
        run: |
          docker build -f webapp/Dockerfile -t ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-webapp:${{ env.IMAGE_TAG }} ./webapp
          docker push ${{ env.DOCKER_REGISTRY }}/${{ steps.repo_owner.outputs.owner_lc }}/overflow-webapp:${{ env.IMAGE_TAG }}

  # ============================================================================
  # STAGING DEPLOYMENT (development branch ‚Üí apps-staging namespace)
  # ============================================================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    needs: build-and-test
    if: |
      (github.ref == 'refs/heads/development' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: self-hosted
    environment: staging
    env:
      KUBECONFIG: /home/github-runner/.kube/config
      NAMESPACE: apps-staging
      OVERLAY: staging
    
    steps:
      - name: üìã Deployment Info
        run: |
          echo "üéØ Deploying to: STAGING"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üì¶ Commit: ${{ github.sha }}"
          echo "üîÑ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üë§ Triggered by: ${{ github.actor }}"
          fi

      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup environment
        id: setup
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: ‚úÖ Verify Kubernetes access
        run: |
          kubectl config current-context || echo "Using default context"
          kubectl get nodes

      - name: üè∑Ô∏è Update image tags
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s/GITHUB_USERNAME/${{ steps.setup.outputs.owner_lc }}/g" kustomization.yaml
          sed -i "s|newTag: latest|newTag: ${{ env.IMAGE_TAG }}|g" kustomization.yaml

      - name: üîê Create image pull secret
        run: |
          # Delete existing secret if it exists
          kubectl delete secret ghcr-pull-secret -n ${{ env.NAMESPACE }} 2>/dev/null || echo "Secret doesn't exist, continuing..."
          
          # Create new secret from GitHub token
          kubectl create secret docker-registry ghcr-pull-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=${{ github.actor }}@users.noreply.github.com \
            -n ${{ env.NAMESPACE }}
          
          echo "‚úÖ ghcr-pull-secret created successfully"

      - name: üîê Inject secrets
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s|postgres-connection=.*|postgres-connection=${{ secrets.POSTGRES_QUESTIONS_DB_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|rabbitmq-connection=.*|rabbitmq-connection=${{ secrets.RABBIT_MQ_AMQP_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|typesense-api-key=.*|typesense-api-key=${{ secrets.TYPESENSE_API_KEY }}|g" kustomization.yaml
          sed -i "s|keycloak-client-id=.*|keycloak-client-id=${{ secrets.KEYCLOAK_CLIENT_ID }}|g" kustomization.yaml
          sed -i "s|keycloak-client-secret=.*|keycloak-client-secret=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|g" kustomization.yaml
          sed -i "s|auth-secret=.*|auth-secret=${{ secrets.AUTH_SECRET }}|g" kustomization.yaml
          sed -i "s|auth-keycloak-secret=.*|auth-keycloak-secret=${{ secrets.AUTH_KEYCLOAK_SECRET }}|g" kustomization.yaml
          sed -i "s|cloudinary-api-key=.*|cloudinary-api-key=${{ secrets.NEXT_PUBLIC_CLOUDINARY_API_KEY }}|g" kustomization.yaml
          sed -i "s|cloudinary-api-secret=.*|cloudinary-api-secret=${{ secrets.CLOUDINARY_API_SECRET }}|g" kustomization.yaml

      - name: üëÄ Preview manifests
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl kustomize . | head -n 100

      - name: üöÄ Deploy to Kubernetes
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl apply -k .

      - name: ‚è≥ Wait for rollout
        run: |
          kubectl rollout status deployment/question-svc -n ${{ env.NAMESPACE }} --timeout=1m
          kubectl rollout status deployment/search-svc -n ${{ env.NAMESPACE }} --timeout=1m
          kubectl rollout status deployment/overflow-webapp -n ${{ env.NAMESPACE }} --timeout=1m

      - name: üìä Deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Logs from question-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=question-svc --tail=30 --prefix=true || true
          echo "=== Logs from search-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=search-svc --tail=30 --prefix=true || true
          echo "=== Logs from overflow-webapp ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=overflow-webapp --tail=30 --prefix=true || true

  # ============================================================================
  # PRODUCTION DEPLOYMENT (main branch ‚Üí apps-production namespace)
  # ============================================================================
  deploy-production:
    name: üè≠ Deploy to Production
    needs: build-and-test
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: self-hosted
    environment: production
    env:
      KUBECONFIG: /home/github-runner/.kube/config
      NAMESPACE: apps-production
      OVERLAY: production
    
    steps:
      - name: üìã Deployment Info
        run: |
          echo "üéØ Deploying to: PRODUCTION"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üì¶ Commit: ${{ github.sha }}"
          echo "üîÑ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üë§ Triggered by: ${{ github.actor }}"
          fi

      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup environment
        id: setup
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: ‚úÖ Verify Kubernetes access
        run: |
          kubectl config current-context || echo "Using default context"
          kubectl get nodes

      - name: üè∑Ô∏è Update image tags
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s/GITHUB_USERNAME/${{ steps.setup.outputs.owner_lc }}/g" kustomization.yaml
          sed -i "s|newTag: latest|newTag: ${{ env.IMAGE_TAG }}|g" kustomization.yaml

      - name: üîê Inject secrets
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: |
          sed -i "s|postgres-connection=.*|postgres-connection=${{ secrets.POSTGRES_QUESTIONS_DB_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|rabbitmq-connection=.*|rabbitmq-connection=${{ secrets.RABBIT_MQ_AMQP_CONNECTION_STRING }}|g" kustomization.yaml
          sed -i "s|typesense-api-key=.*|typesense-api-key=${{ secrets.TYPESENSE_API_KEY }}|g" kustomization.yaml
          sed -i "s|keycloak-client-id=.*|keycloak-client-id=${{ secrets.KEYCLOAK_CLIENT_ID }}|g" kustomization.yaml
          sed -i "s|keycloak-client-secret=.*|keycloak-client-secret=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|g" kustomization.yaml
          sed -i "s|auth-secret=.*|auth-secret=${{ secrets.AUTH_SECRET }}|g" kustomization.yaml
          sed -i "s|auth-keycloak-secret=.*|auth-keycloak-secret=${{ secrets.AUTH_KEYCLOAK_SECRET }}|g" kustomization.yaml
          sed -i "s|cloudinary-api-key=.*|cloudinary-api-key=${{ secrets.NEXT_PUBLIC_CLOUDINARY_API_KEY }}|g" kustomization.yaml
          sed -i "s|cloudinary-api-secret=.*|cloudinary-api-secret=${{ secrets.CLOUDINARY_API_SECRET }}|g" kustomization.yaml

      - name: üëÄ Preview manifests
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl kustomize . | head -n 100

      - name: üöÄ Deploy to Kubernetes
        working-directory: ./k8s/overlays/${{ env.OVERLAY }}
        run: kubectl apply -k .

      - name: ‚è≥ Wait for rollout
        run: |
          kubectl rollout status deployment/question-svc -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/search-svc -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/overflow-webapp -n ${{ env.NAMESPACE }} --timeout=5m

      - name: üìä Deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Logs from question-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=question-svc --tail=30 --prefix=true || true
          echo "=== Logs from search-svc ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=search-svc --tail=30 --prefix=true || true

      - name: üß™ Smoke tests
        run: |
          sleep 10
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -f -m 5 http://question-svc:8080/health || echo "‚ö†Ô∏è Health check failed"
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -f -m 5 http://search-svc:8080/health || echo "‚ö†Ô∏è Health check failed"
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -f -m 5 http://overflow-webapp:3000/ || echo "‚ö†Ô∏è Health check failed"
