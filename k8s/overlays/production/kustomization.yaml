# Production Environment Kustomization
# Namespace: apps-production | Replicas: 3 per service (high availability)

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: apps-production

resources:
  - ../../base/question-svc
  - ../../base/search-svc
  - ../../base/webapp
  - ingress.yaml

# Image tags updated by CI/C
images:
  - name: ghcr.io/placeholder/overflow-question
    newName: ghcr.io/GITHUB_USERNAME/overflow-question
    newTag: latest
  - name: ghcr.io/placeholder/overflow-search
    newName: ghcr.io/GITHUB_USERNAME/overflow-search
    newTag: latest
  - name: ghcr.io/placeholder/overflow-webapp
    newName: ghcr.io/GITHUB_USERNAME/overflow-webapp
    newTag: latest

configMapGenerator:
  - name: app-config
    behavior: create
    literals:
      - aspnetcore-environment=Production
  - name: webapp-config
    behavior: create
    envs:
      - ../../webapp/.env.production

# Secrets replaced by CI/CD with actual values from GitHub Secrets
secretGenerator:
  - name: app-secrets
    behavior: create
    literals:
      - postgres-connection=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - rabbitmq-connection=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - typesense-connection=http://typesense.infra-production.svc.cluster.local:8108
      - typesense-api-key=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - keycloak-client-id=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - keycloak-client-secret=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
  - name: webapp-secrets
    behavior: create
    literals:
      - auth-secret=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - auth-keycloak-secret=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - cloudinary-api-key=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD
      - cloudinary-api-secret=PLACEHOLDER_WILL_BE_REPLACED_BY_CICD

labels:
  - pairs:
      environment: production
      managed-by: kustomize

replicas:
  - name: question-svc
    count: 3
  - name: search-svc
    count: 3
  - name: overflow-webapp
    count: 3

# Production-specific resource adjustments
patches:
  # Ingress host configuration for production
  - target:
      kind: Ingress
      name: question-svc
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: overflow-api.helios
  - target:
      kind: Ingress
      name: search-svc
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: overflow-api.helios
  
  # Resource adjustments for production
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
    target:
      kind: Deployment
      name: question-svc
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
    target:
      kind: Deployment
      name: search-svc
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
    target:
      kind: Deployment
      name: overflow-webapp
